import React, { useState, useEffect } from 'react';
import './App.css';
import TextInput from './components/TextInput';
import VideoInput from './components/VideoInput';
import ImageInput from './components/ImageInput';
import AudioInput from './components/AudioInput';
import MaterialLibrary from './components/MaterialLibrary';
import KnowledgeGraph from './components/KnowledgeGraph';
import SmartDiagnosis from './components/SmartDiagnosis';
import DecisionTree from './components/DecisionTree';
import { analyzeText, analyzeVideo } from './api/faultAnalysis';
import DiagnosisResult from './components/DiagnosisResult';
import { 
  CircularProgress, 
  AppBar, 
  Toolbar, 
  Typography, 
  Container, 
  Box, 
  Tabs, 
  Tab, 
  Paper, 
  Alert,
  Snackbar,
  IconButton,
  Menu,
  MenuItem,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Card,
  CardContent,
  Avatar,
  Chip,
  Grid
} from '@mui/material';
import { 
  Settings as SettingsIcon,
  Close as CloseIcon,
  Upload as UploadIcon,
  Delete as DeleteIcon
} from '@mui/icons-material';
import { 
  DiagnosisResult as DiagnosisResultType, 
  Statistics,
  MaterialItem,
  CustomLogo
} from './types';

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;

  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`simple-tabpanel-${index}`}
      aria-labelledby={`simple-tab-${index}`}
      {...other}
    >
      {value === index && (
        <Box sx={{ p: 3 }}>
          {children}
        </Box>
      )}
    </div>
  );
}

function a11yProps(index: number) {
  return {
    id: `simple-tab-${index}`,
    'aria-controls': `simple-tabpanel-${index}`,
  };
}

function App() {
  const [tabValue, setTabValue] = useState(0);
  const [diagnosisResult, setDiagnosisResult] = useState<DiagnosisResultType | null>(null);
  const [statistics, setStatistics] = useState<Statistics>({
    totalFrames: 0,
    analyzedFrames: 0,
    abnormalFrames: 0,
    abnormalRatio: 0,
    duration: 0
  });
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [analysisType, setAnalysisType] = useState<'text' | 'video' | 'image' | 'audio'>('text');
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState('');
  const [snackbarSeverity, setSnackbarSeverity] = useState<'success' | 'error' | 'warning' | 'info'>('info');

  // çŸ¥è¯†åº“ç›¸å…³çŠ¶æ€
  const [knowledgeDocuments, setKnowledgeDocuments] = useState<any[]>([]);
  const [showKnowledgeGraph, setShowKnowledgeGraph] = useState(false);

  // ç´ æåº“ç›¸å…³çŠ¶æ€
  const [materials, setMaterials] = useState<MaterialItem[]>([]);

  // Logoå’Œè®¾ç½®ç›¸å…³çŠ¶æ€
  const [selectedLogo, setSelectedLogo] = useState<string>('default');
  const [customLogos, setCustomLogos] = useState<CustomLogo[]>([]);
  const [settingsMenuAnchor, setSettingsMenuAnchor] = useState<null | HTMLElement>(null);
  const [settingsDialogOpen, setSettingsDialogOpen] = useState(false);

  // é¢„è®¾Logoé€‰é¡¹
  const presetLogos = [
    { id: 'default', name: 'é»˜è®¤Logo', icon: 'ğŸ”‹' },
    { id: 'battery', name: 'ç”µæ± å›¾æ ‡', icon: 'âš¡' },
    { id: 'gear', name: 'é½¿è½®å›¾æ ‡', icon: 'âš™ï¸' },
    { id: 'tools', name: 'å·¥å…·å›¾æ ‡', icon: 'ğŸ”§' },
    { id: 'car', name: 'æ±½è½¦å›¾æ ‡', icon: 'ğŸš—' }
  ];

  // ä»localStorageåŠ è½½è®¾ç½®
  useEffect(() => {
    const savedLogo = localStorage.getItem('selectedLogo');
    const savedCustomLogos = localStorage.getItem('customLogos');
    
    if (savedLogo) {
      setSelectedLogo(savedLogo);
    }
    
    if (savedCustomLogos) {
      try {
        setCustomLogos(JSON.parse(savedCustomLogos));
      } catch (error) {
        console.error('åŠ è½½è‡ªå®šä¹‰Logoå¤±è´¥:', error);
      }
    }
  }, []);

  // ä¿å­˜Logoè®¾ç½®
  const saveLogoSettings = () => {
    localStorage.setItem('selectedLogo', selectedLogo);
    localStorage.setItem('customLogos', JSON.stringify(customLogos));
  };

  // å¤„ç†Logoé€‰æ‹©
  const handleLogoSelect = (logoId: string) => {
    setSelectedLogo(logoId);
  };

  // å¤„ç†è‡ªå®šä¹‰Logoä¸Šä¼ 
  const handleCustomLogoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        showSnackbar('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å° (2MB)
      if (file.size > 2 * 1024 * 1024) {
        showSnackbar('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡2MB', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const result = e.target?.result as string;
        const newLogo: CustomLogo = {
          id: `custom_${Date.now()}`,
          name: file.name,
          dataUrl: result,
          uploadDate: new Date().toISOString()
        };
        
        setCustomLogos(prev => [...prev, newLogo]);
        showSnackbar('Logoä¸Šä¼ æˆåŠŸ', 'success');
      };
      reader.readAsDataURL(file);
    }
  };

  // åˆ é™¤è‡ªå®šä¹‰Logo
  const handleDeleteCustomLogo = (logoId: string) => {
    setCustomLogos(prev => prev.filter(logo => logo.id !== logoId));
    if (selectedLogo === logoId) {
      setSelectedLogo('default');
    }
    showSnackbar('Logoå·²åˆ é™¤', 'info');
  };

  // è·å–å½“å‰Logoæ˜¾ç¤º
  const getCurrentLogoDisplay = () => {
    if (selectedLogo === 'default') return 'ğŸ”‹';
    
    const presetLogo = presetLogos.find(logo => logo.id === selectedLogo);
    if (presetLogo) return presetLogo.icon;
    
    const customLogo = customLogos.find(logo => logo.id === selectedLogo);
    if (customLogo) {
      return <img src={customLogo.dataUrl} alt={customLogo.name} style={{ width: 32, height: 32, borderRadius: 4 }} />;
    }
    
    return 'ğŸ”‹';
  };

  const showSnackbar = (message: string, severity: 'success' | 'error' | 'warning' | 'info' = 'info') => {
    setSnackbarMessage(message);
    setSnackbarSeverity(severity);
    setSnackbarOpen(true);
  };

  const handleCloseSnackbar = () => {
    setSnackbarOpen(false);
  };

  const handleTabChange = (event: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };

  // å¤„ç†æ–‡æœ¬åˆ†æ
  const handleTextAnalysis = async (text: string) => {
    setLoading(true);
    setError(null);
    setAnalysisType('text');
    
    try {
      const result = await analyzeText(text);
      setDiagnosisResult(result);
      showSnackbar('æ–‡æœ¬åˆ†æå®Œæˆ', 'success');
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æ–‡æœ¬åˆ†æå¤±è´¥';
      setError(errorMessage);
      showSnackbar(errorMessage, 'error');
    } finally {
      setLoading(false);
    }
  };

  // å¤„ç†è§†é¢‘åˆ†æ
  const handleVideoAnalysis = async (videoFile: File) => {
    setLoading(true);
    setError(null);
    setAnalysisType('video');
    
    try {
      const result = await analyzeVideo(videoFile);
      setDiagnosisResult(result.diagnosis);
      setStatistics(result.statistics);
      showSnackbar('è§†é¢‘åˆ†æå®Œæˆ', 'success');
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'è§†é¢‘åˆ†æå¤±è´¥';
      setError(errorMessage);
      showSnackbar(errorMessage, 'error');
    } finally {
      setLoading(false);
    }
  };

  // å¤„ç†å›¾ç‰‡åˆ†æ
  const handleImageAnalysis = async (analysisData: any, files: File[]) => {
    setLoading(true);
    setError(null);
    setAnalysisType('image');
    
    try {
      const result = convertImageAnalysisToResult(analysisData, files);
      setDiagnosisResult(result);
      showSnackbar('å›¾ç‰‡åˆ†æå®Œæˆ', 'success');
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'å›¾ç‰‡åˆ†æå¤±è´¥';
      setError(errorMessage);
      showSnackbar(errorMessage, 'error');
    } finally {
      setLoading(false);
    }
  };

  // è½¬æ¢ImageInputçš„åˆ†æç»“æœä¸ºæ ‡å‡†æ ¼å¼
  const convertImageAnalysisToResult = (analysisData: any, files: File[]): DiagnosisResultType => {
    const { individualAnalyses, overallSummary, prioritizedSolutions } = analysisData;
    
    // è½¬æ¢å¼‚å¸¸æ£€æµ‹ç»“æœ
    const anomalies = individualAnalyses.flatMap((analysis: any, index: number) => 
      analysis.detectedAnomalies.map((anomaly: any) => ({
        type: anomaly.type,
        severity: anomaly.severity,
        confidence: anomaly.confidence,
        location: anomaly.location,
        description: anomaly.description,
        frameIndex: index,
        timestamp: index * 1000, // å‡è®¾æ¯å¼ å›¾ç‰‡é—´éš”1ç§’
        boundingBox: anomaly.boundingBox
      }))
    );

    // è½¬æ¢è§£å†³æ–¹æ¡ˆ
    const solutions = prioritizedSolutions.map((solution: any) => ({
      id: solution.id,
      title: solution.title,
      description: solution.description,
      priority: solution.priority,
      estimatedTime: solution.estimatedTime,
      difficulty: solution.difficulty,
      tools: solution.tools || [],
      steps: solution.steps || [],
      safetyNotes: solution.safetyNotes || []
    }));

    return {
      id: `img_analysis_${Date.now()}`,
      timestamp: new Date().toISOString(),
      analysisType: 'image',
      summary: overallSummary.summary,
      severity: overallSummary.overallSeverity,
      confidence: overallSummary.averageConfidence,
      anomalies: anomalies,
      solutions: solutions,
      recommendations: overallSummary.recommendations || [],
      metadata: {
        totalImages: files.length,
        imageNames: files.map(f => f.name),
        analysisMethod: 'multi-image-analysis'
      }
    };
  };

  // å¤„ç†çŸ¥è¯†åº“æ›´æ–°
  const handleKnowledgeUpdate = (documents: any[]) => {
    setKnowledgeDocuments(documents);
  };

  // å¤„ç†ç´ æåº“æ›´æ–°
  const handleMaterialsUpdate = (newMaterials: MaterialItem[]) => {
    setMaterials(newMaterials);
  };

  // è®¾ç½®èœå•å¤„ç†
  const handleSettingsClick = (event: React.MouseEvent<HTMLElement>) => {
    setSettingsMenuAnchor(event.currentTarget);
  };

  const handleSettingsClose = () => {
    setSettingsMenuAnchor(null);
  };

  const handleSettingsDialogOpen = () => {
    setSettingsDialogOpen(true);
    handleSettingsClose();
  };

  const handleSettingsDialogClose = () => {
    setSettingsDialogOpen(false);
  };

  const handleSaveSettings = () => {
    saveLogoSettings();
    handleSettingsDialogClose();
    showSnackbar('è®¾ç½®å·²ä¿å­˜', 'success');
  };

  return (
    <div className="App">
      <AppBar position="static" sx={{ backgroundColor: '#1976d2' }}>
        <Toolbar>
          <Box sx={{ display: 'flex', alignItems: 'center', mr: 2 }}>
            {typeof getCurrentLogoDisplay() === 'string' ? (
              <Typography variant="h6" component="span" sx={{ mr: 1 }}>
                {getCurrentLogoDisplay()}
              </Typography>
            ) : (
              getCurrentLogoDisplay()
            )}
          </Box>
          <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
            ç”µåŠ¨æ±½è½¦æ¢ç”µç«™æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ
          </Typography>
          <IconButton
            color="inherit"
            onClick={handleSettingsClick}
            sx={{ ml: 2 }}
          >
            <SettingsIcon />
          </IconButton>
        </Toolbar>
      </AppBar>

      {/* è®¾ç½®èœå• */}
      <Menu
        anchorEl={settingsMenuAnchor}
        open={Boolean(settingsMenuAnchor)}
        onClose={handleSettingsClose}
      >
        <MenuItem onClick={handleSettingsDialogOpen}>
          ç³»ç»Ÿè®¾ç½®
        </MenuItem>
      </Menu>

      {/* è®¾ç½®å¯¹è¯æ¡† */}
      <Dialog 
        open={settingsDialogOpen} 
        onClose={handleSettingsDialogClose}
        maxWidth="md"
        fullWidth
      >
        <DialogTitle>
          ç³»ç»Ÿè®¾ç½®
          <IconButton
            onClick={handleSettingsDialogClose}
            sx={{ position: 'absolute', right: 8, top: 8 }}
          >
            <CloseIcon />
          </IconButton>
        </DialogTitle>
        <DialogContent>
          <Box sx={{ mt: 2 }}>
            <Typography variant="h6" gutterBottom>
              Logoè®¾ç½®
            </Typography>
            
            {/* å½“å‰Logoæ˜¾ç¤º */}
            <Card sx={{ mb: 3 }}>
              <CardContent>
                <Typography variant="subtitle2" gutterBottom>
                  å½“å‰Logo
                </Typography>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                  {typeof getCurrentLogoDisplay() === 'string' ? (
                    <Typography variant="h4">{getCurrentLogoDisplay()}</Typography>
                  ) : (
                    getCurrentLogoDisplay()
                  )}
                  <Typography variant="body2" color="text.secondary">
                    {selectedLogo === 'default' ? 'é»˜è®¤Logo' : 
                     presetLogos.find(l => l.id === selectedLogo)?.name ||
                     customLogos.find(l => l.id === selectedLogo)?.name ||
                     'æœªçŸ¥Logo'}
                  </Typography>
                </Box>
              </CardContent>
            </Card>

            {/* é¢„è®¾Logoé€‰æ‹© */}
            <Typography variant="subtitle1" gutterBottom>
              é¢„è®¾Logo
            </Typography>
            <Grid container spacing={2} sx={{ mb: 3 }}>
              {presetLogos.map((logo) => (
                <Grid item xs={6} sm={4} md={3} key={logo.id}>
                  <Card 
                    sx={{ 
                      cursor: 'pointer',
                      border: selectedLogo === logo.id ? 2 : 1,
                      borderColor: selectedLogo === logo.id ? 'primary.main' : 'divider'
                    }}
                    onClick={() => handleLogoSelect(logo.id)}
                  >
                    <CardContent sx={{ textAlign: 'center', py: 2 }}>
                      <Typography variant="h4" sx={{ mb: 1 }}>
                        {logo.icon}
                      </Typography>
                      <Typography variant="caption">
                        {logo.name}
                      </Typography>
                      {selectedLogo === logo.id && (
                        <Chip 
                          label="ä½¿ç”¨ä¸­" 
                          size="small" 
                          color="primary" 
                          sx={{ mt: 1 }}
                        />
                      )}
                    </CardContent>
                  </Card>
                </Grid>
              ))}
            </Grid>

            {/* è‡ªå®šä¹‰Logoä¸Šä¼  */}
            <Typography variant="subtitle1" gutterBottom>
              è‡ªå®šä¹‰Logo
            </Typography>
            <Box sx={{ mb: 2 }}>
              <input
                accept="image/*"
                style={{ display: 'none' }}
                id="logo-upload"
                type="file"
                onChange={handleCustomLogoUpload}
              />
              <label htmlFor="logo-upload">
                <Button
                  variant="outlined"
                  component="span"
                  startIcon={<UploadIcon />}
                >
                  ä¸Šä¼ è‡ªå®šä¹‰Logo
                </Button>
              </label>
              <Typography variant="caption" display="block" sx={{ mt: 1, color: 'text.secondary' }}>
                æ”¯æŒJPGã€PNGã€GIFæ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡2MB
              </Typography>
            </Box>

            {/* è‡ªå®šä¹‰Logoåˆ—è¡¨ */}
            {customLogos.length > 0 && (
              <Grid container spacing={2}>
                {customLogos.map((logo) => (
                  <Grid item xs={6} sm={4} md={3} key={logo.id}>
                    <Card 
                      sx={{ 
                        cursor: 'pointer',
                        border: selectedLogo === logo.id ? 2 : 1,
                        borderColor: selectedLogo === logo.id ? 'primary.main' : 'divider'
                      }}
                    >
                      <CardContent sx={{ textAlign: 'center', py: 2 }}>
                        <Avatar
                          src={logo.dataUrl}
                          alt={logo.name}
                          sx={{ width: 48, height: 48, mx: 'auto', mb: 1 }}
                        />
                        <Typography variant="caption" display="block" noWrap>
                          {logo.name}
                        </Typography>
                        <Box sx={{ mt: 1, display: 'flex', gap: 1, justifyContent: 'center' }}>
                          <Button
                            size="small"
                            variant={selectedLogo === logo.id ? "contained" : "outlined"}
                            onClick={() => handleLogoSelect(logo.id)}
                          >
                            {selectedLogo === logo.id ? 'ä½¿ç”¨ä¸­' : 'ä½¿ç”¨'}
                          </Button>
                          <IconButton
                            size="small"
                            color="error"
                            onClick={() => handleDeleteCustomLogo(logo.id)}
                          >
                            <DeleteIcon fontSize="small" />
                          </IconButton>
                        </Box>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>
            )}
          </Box>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleSettingsDialogClose}>
            å–æ¶ˆ
          </Button>
          <Button onClick={handleSaveSettings} variant="contained">
            ä¿å­˜è®¾ç½®
          </Button>
        </DialogActions>
      </Dialog>

      <Container maxWidth="xl" sx={{ mt: 2 }}>
        {error && (
          <Alert severity="error" sx={{ mb: 2 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        <Paper elevation={3}>
          <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
            <Tabs value={tabValue} onChange={handleTabChange} aria-label="è¯Šæ–­ç³»ç»Ÿæ ‡ç­¾é¡µ">
              <Tab label="æ–‡æœ¬è¯Šæ–­" {...a11yProps(0)} />
              <Tab label="è§†é¢‘åˆ†æ" {...a11yProps(1)} />
              <Tab label="å›¾åƒè¯†åˆ«" {...a11yProps(2)} />
              <Tab label="éŸ³é¢‘åˆ†æ" {...a11yProps(3)} />
              <Tab label="ç´ æåº“" {...a11yProps(4)} />
              <Tab label="çŸ¥è¯†å›¾è°±" {...a11yProps(5)} />
              <Tab label="æ™ºèƒ½è¯Šæ–­" {...a11yProps(6)} />
              <Tab label="å†³ç­–æ ‘" {...a11yProps(7)} />
            </Tabs>
          </Box>

          <TabPanel value={tabValue} index={0}>
            <TextInput onAnalysis={handleTextAnalysis} loading={loading} />
          </TabPanel>

          <TabPanel value={tabValue} index={1}>
            <VideoInput onAnalysis={handleVideoAnalysis} loading={loading} />
          </TabPanel>

          <TabPanel value={tabValue} index={2}>
            <ImageInput onAnalysis={handleImageAnalysis} loading={loading} />
          </TabPanel>

          <TabPanel value={tabValue} index={3}>
            <AudioInput loading={loading} />
          </TabPanel>

          <TabPanel value={tabValue} index={4}>
            <MaterialLibrary 
              materials={materials}
              onMaterialsUpdate={handleMaterialsUpdate}
            />
          </TabPanel>

          <TabPanel value={tabValue} index={5}>
            <KnowledgeGraph 
              documents={knowledgeDocuments}
              onDocumentsUpdate={handleKnowledgeUpdate}
            />
          </TabPanel>

          <TabPanel value={tabValue} index={6}>
            <SmartDiagnosis />
          </TabPanel>

          <TabPanel value={tabValue} index={7}>
            <DecisionTree />
          </TabPanel>
        </Paper>

        {/* è¯Šæ–­ç»“æœæ˜¾ç¤º */}
        {diagnosisResult && (
          <Box sx={{ mt: 3 }}>
            <DiagnosisResult 
              result={diagnosisResult} 
              statistics={statistics}
              analysisType={analysisType}
            />
          </Box>
        )}

        {/* åŠ è½½æŒ‡ç¤ºå™¨ */}
        {loading && (
          <Box 
            sx={{ 
              position: 'fixed', 
              top: 0, 
              left: 0, 
              width: '100%', 
              height: '100%', 
              backgroundColor: 'rgba(0, 0, 0, 0.5)', 
              display: 'flex', 
              justifyContent: 'center', 
              alignItems: 'center', 
              zIndex: 9999 
            }}
          >
            <Box sx={{ textAlign: 'center', color: 'white' }}>
              <CircularProgress color="inherit" size={60} />
              <Typography variant="h6" sx={{ mt: 2 }}>
                æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...
              </Typography>
            </Box>
          </Box>
        )}
      </Container>

      {/* æ¶ˆæ¯æç¤º */}
      <Snackbar
        open={snackbarOpen}
        autoHideDuration={6000}
        onClose={handleCloseSnackbar}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      >
        <Alert onClose={handleCloseSnackbar} severity={snackbarSeverity} sx={{ width: '100%' }}>
          {snackbarMessage}
        </Alert>
      </Snackbar>
    </div>
  );
}

export default App; 
